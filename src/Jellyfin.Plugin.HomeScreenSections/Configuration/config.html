<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Home Screen Sections</title>
</head>
<body>
<div data-role="page" id="homeScreenSectionsConfigurationPage" class="page type-interior pluginConfigurationPage fullWidthContent">
    <script src="/HomeScreen/client/shared-utils.js"></script>
    <div class="content-primary" style="display: flex !important; flex-direction: column !important; width: 100% !important; max-width: 1200px !important; margin: 0 auto !important; padding: 0 2em !important; box-sizing: border-box !important;">
        <div class="verticalSection">
            <div class="sectionTitleContainer">
                <h2 class="sectionTitle">Home Screen Sections</h2>
                <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;" target="_blank" href="https://github.com/IAmParadox27/jellyfin-plugin-home-sections">
                    <i class="md-icon button-icon button-icon-left secondaryText"></i>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <div style="margin-bottom: 1.5em;">
            <button class="jellyfin-tab-button active" data-tab="global" style="background: none; border: none; color: #fff; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid #fff; padding: 0.5em 1em;"><h3>Global Settings</h3></button>
            <button class="jellyfin-tab-button" data-tab="sections" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent; padding: 0.5em 1em;"><h3>Section Settings</h3></button>
            <button class="jellyfin-tab-button" data-tab="debug" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent; padding: 0.5em 1em;"><h3>Debug</h3></button>
        </div>

        <form class="artworkConfigurationForm" style="max-width: none !important; width: 100% !important; flex: 1 !important;">
            <div id="global" class="jellyfin-tab-content active" style="display: block;">
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Default Settings</legend>
                    <div style="padding-left: .5em;">
                        <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1.5em;">
                            <label class="emby-checkbox-label">
                                <input id="globalEnabledDefault" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                                <span>Enabled by Default</span>
                            </label>
                            <div class="fieldDescription">Enable Home Screen Sections by default for all users?</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="globalAllowUserOverride" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                                <span>Allow User Override</span>
                            </label>
                            <div class="fieldDescription">Can users enable/disable this plugin for their own view?</div>
                        </div>
                    </div>
                </fieldset>
    
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Upcoming Section Settings</legend>
                    <div style="padding-left: .5em;">
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="upcomingShowsTimeframeValue">Upcoming Shows Timeframe</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input is="emby-input" type="number" id="upcomingShowsTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                                <select is="emby-select" id="upcomingShowsTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                    <option value="Days">Days</option>
                                    <option value="Weeks">Weeks</option>
                                    <option value="Months">Months</option>
                                    <option value="Years">Years</option>
                                </select>
                            </div>
                            <div class="fieldDescription">How far in the future should we look for upcoming episodes?</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="upcomingMoviesTimeframeValue">Upcoming Movies Timeframe</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input is="emby-input" type="number" id="upcomingMoviesTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                                <select is="emby-select" id="upcomingMoviesTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                    <option value="Days">Days</option>
                                    <option value="Weeks">Weeks</option>
                                    <option value="Months">Months</option>
                                    <option value="Years">Years</option>
                                </select>
                            </div>
                            <div class="fieldDescription">How far in the future should we look for upcoming movies?</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="upcomingMusicTimeframeValue">Upcoming Music Timeframe</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input is="emby-input" type="number" id="upcomingMusicTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                                <select is="emby-select" id="upcomingMusicTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                    <option value="Days">Days</option>
                                    <option value="Weeks">Weeks</option>
                                    <option value="Months">Months</option>
                                    <option value="Years">Years</option>
                                </select>
                            </div>
                            <div class="fieldDescription">How far in the future should we look for upcoming music releases?</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="upcomingBooksTimeframeValue">Upcoming Books Timeframe</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input is="emby-input" type="number" id="upcomingBooksTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                                <select is="emby-select" id="upcomingBooksTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                    <option value="Days">Days</option>
                                    <option value="Weeks">Weeks</option>
                                    <option value="Months">Months</option>
                                    <option value="Years">Years</option>
                                </select>
                            </div>
                            <div class="fieldDescription">How far in the future should we look for upcoming book releases?</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="dateFormat">Date Format</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select is="emby-select" id="dateFormat" class="emby-select-withcolor emby-select" style="flex: 0 0 150px;">
                                    <option value="YYYY/MM/DD">YYYY/MM/DD</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="DD/MM">DD/MM</option>
                                    <option value="MM/DD">MM/DD</option>
                                </select>
                                <input is="emby-input" type="text" id="dateDelimiter" maxlength="3" style="flex: 0 0 60px;" placeholder="/" />
                            </div>
                            <div class="fieldDescription">How should dates be displayed?</div>
                        </div>
                    </div>
                </fieldset>
    
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Advanced Settings</legend>
                    <div style="padding-left: .5em;">
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">*arr API Settings</summary>
                            <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtSonarrUrl" label="Sonarr URL" />
                                    <div class="fieldDescription">Complete URL for Sonarr to use for upcoming shows sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtSonarrApiKey" label="Sonarr API Key" />
                                    <div class="fieldDescription">API Key for Sonarr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtRadarrUrl" label="Radarr URL" />
                                    <div class="fieldDescription">Complete URL for Radarr to use for upcoming movies sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtRadarrApiKey" label="Radarr API Key" />
                                    <div class="fieldDescription">API Key for Radarr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtLidarrUrl" label="Lidarr URL" />
                                    <div class="fieldDescription">Complete URL for Lidarr to use for upcoming music sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtLidarrApiKey" label="Lidarr API Key" />
                                    <div class="fieldDescription">API Key for Lidarr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtReadarrUrl" label="Readarr URL" />
                                    <div class="fieldDescription">Complete URL for Readarr to use for upcoming books sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtReadarrApiKey" label="Readarr API Key" />
                                    <div class="fieldDescription">API Key for Readarr instance.</div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">LibreTranslate</summary>
                            <div style="padding-top: 1em;">
                                 <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtLibreTranslateUrl" label="LibreTranslate URL" />
                                    <div class="fieldDescription">URL for LibreTranslate instance to use for translations.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtLibreTranslateApiKey" required="required" label="LibreTranslate API Key" />
                                    <div class="fieldDescription">API Key for LibreTranslate instance.</div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Jellyseerr</summary>
                             <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtJellyseerrUrl" label="Jellyseerr URL" />
                                    <div class="fieldDescription">URL for Jellyseerr to use for Discover sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtJellyseerrApiKey" required="required" label="Jellyseerr API Key" />
                                    <div class="fieldDescription">API Key for Jellyseerr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtJellyseerrPreferredLanguages" required="required" label="Discover Sections Language Filter" />
                                    <div class="fieldDescription">Preferred languages to filter for Discover section. (comma delimited)</div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Default Libraries</summary>
                            <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultMoviesLibrary">Default Movies Library</label>
                                    <select is="emby-select" id="defaultMoviesLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific movies library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultTVShowsLibrary">Default TV Shows Library</label>
                                    <select is="emby-select" id="defaultTVShowsLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific TV shows library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultMusicLibrary">Default Music Library</label>
                                    <select is="emby-select" id="defaultMusicLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific music library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultBooksLibrary">Default Books Library</label>
                                    <select is="emby-select" id="defaultBooksLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific books library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Cache</summary>
                            <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <input is="emby-input" type="number" data-id="txtCacheTimeoutSeconds" label="Cache Timeout (seconds)" min="0" max="604800" />
                                    <div class="fieldDescription">How long browsers should cache plugin resources (default: 86400 = 24 hours). Set to 0 to disable caching.</div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary style="cursor: pointer; font-weight: bold;">Third-Party Integrations</summary>
                            <div style="padding-top: 1em;">
                                <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1.5em;">
                                    <label class="emby-checkbox-label">
                                        <input id="globalStreamyfinHomeOverride" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                                        <span>Override Streamyfin Home</span>
                                    </label>
                                    <div class="fieldDescription">Should requests for the Streamyfin config overwrite the home section with a Home Screen Sections generation.<br /><br/><i>Please Note: This functionality behind this setting is currently highly experimental and more work is likely needed before this is finalised.</i></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </fieldset>
    
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Developer Settings</legend>
                    <div style="padding-left: .5em;">
                        <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1.5em;">
                            <label class="emby-checkbox-label">
                                <input id="globalDeveloperMode" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                                <span>Developer Mode</span>
                            </label>
                            <div class="fieldDescription">Disable browser caching for plugin resources during development.</div>
                        </div>
                        <div style="margin-top: 1em;">
                            <div style="display: flex; gap: 1em; align-items: center; flex-wrap: wrap;">
                                <button type="button" id="btnBustHomeSectionsCache" class="raised button-submit emby-button">
                                    <span>Bust Static Assets Cache</span>
                                </button>
                                <button type="button" id="btnBustAllCaches" class="raised emby-button" style="background-color: #2196F3;">
                                    <span>Bust All Caches (Assets + Index)</span>
                                </button>
                                <span id="cacheBustStatus" style="color: #52b54b; display: none; font-weight: bold;"></span>
                            </div>
                            <div style="margin-top: 0.5em; font-size: 0.9em; color: #ccc;">
                                <strong>Static Assets Cache:</strong> Clears browser cache for CSS/JS files only.<br>
                                <strong>All Caches:</strong> Clears both static assets and index.html transformation cache.
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>
            
            <div id="sections" class="jellyfin-tab-content" style="display: none;">
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Section Settings</legend>
                    <div style="margin-bottom: 2em;">
                        <h4>Field Descriptions:</h4>
                        <ul style="margin: 0; padding-left: 1.5em;">
                            <li><strong>Order:</strong> Sets the display order for this section in Jellyfin. Lower numbers appear first. <i>Note: Sections with the same number are shown in random order among themselves.</i></li>
                            <li><strong>Enabled:</strong> Enable this section by default.</li>
                            <li><strong>Allow User Overrides:</strong> Enable user customization for this section. When checked, all available settings become user-customizable by default. <i>Individual settings can be restricted in the section details if needed.</i></li>
                            <li><strong>Lower Limit (Min):</strong> The minimum number of times this section should appear.</li>
                            <li><strong>Upper Limit (Max):</strong> The maximum number of times this section can appear.</li>
                            <li><strong>View Mode:</strong> Defines the card layout used when displaying results.<i>If disabled, the section only supports the displayed layout.</i></li>
                        </ul>
                        <div style="margin-top: 1.5em;">
                            <h4>User Override System:</h4>
                            <ul style="margin: 0; padding-left: 1.5em;">
                                <li><strong>Simple Control:</strong> Check "Allow User Overrides" to let users customize this section's settings.</li>
                                <li><strong>Default Behavior:</strong> When enabled, all available settings become user-customizable by default.</li>
                                <li><strong>Fine-Tuning:</strong> Expand section details to restrict specific settings if needed.</li>
                                <li><strong>Configuration Priority:</strong> User Setting → Admin Setting → Built-in Default</li>
                            </ul>
                        </div>
                    </div>
                    <div class="advanced-toggle">
                        <label class="emby-checkbox-label">
                            <input id="adminShowAdvanced" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                            <span class="checkboxLabel">Show Advanced Options</span>
                            <span class="checkboxOutline">
                                <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                <span class="material-icons checkboxIcon checkboxIcon-unchecked "></span>
                            </span>
                        </label>
                        <div class="fieldDescription">Toggle visibility of advanced settings like custom display names and advanced option fields.</div>
                    </div>
                    
                    <div class="expand-collapse-controls" style="margin: 1em 0; display:flex; gap:.75em; flex-wrap:wrap;">
                        <button type="button" is="emby-button" class="raised mini emby-button" id="btnExpandAllSections"><span>Expand All</span></button>
                        <button type="button" is="emby-button" class="raised mini emby-button" id="btnCollapseAllSections"><span>Collapse All</span></button>
                    </div>
                    <table id="sectionsTable" class="tblConnections" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Section</th>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Order</th>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Enabled</th>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">User Override</th>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Min</th>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Max</th>
                                <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">View Mode</th>
                            </tr>
                        </thead>
                        <tbody id="sectionWrapper"></tbody>
                    </table>
                </fieldset>
            </div>

            <div id="debug" class="jellyfin-tab-content" style="display: none;">
                <!-- Refresh Button -->
                <div style="margin-bottom: 2em;">
                    <button type="button" is="emby-button" class="raised button-submit" id="btnRefreshDebug">
                        <span>Refresh Debug Data</span>
                    </button>
                </div>
                
                <!-- Admin Debug Section -->
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Admin Debug</legend>
                    <div style="padding-left: .5em;">
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Plugin Configuration</summary>
                            <div id="adminConfigContent" style="padding: 1em; font-family: monospace; font-size: 11px; background: #2a2a2a; color: #d4d4d4; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">
                                <div style="color: #9cdcfe;">Click "Refresh Debug Data" to load...</div>
                            </div>
                        </details>
                        
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Section Types</summary>
                            <div id="adminSectionTypesContent" style="padding: 1em; font-family: monospace; font-size: 11px; background: #2a2a2a; color: #d4d4d4; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">
                                <div style="color: #9cdcfe;">Click "Refresh Debug Data" to load...</div>
                            </div>
                        </details>
                    </div>
                </fieldset>
                
                <!-- User Debug Section -->
                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">User Debug</legend>
                    <div style="padding-left: .5em;">
                        <div style="margin-bottom: 1em;">
                            <h4 style="margin: 0 0 0.5em 0; font-weight: bold;">User Selector</h4>
                            <div id="userSelectorControls" style="padding: 1em;">
                                <div style="color: #9cdcfe;">Click "Refresh Debug Data" to load...</div>
                            </div>
                        </div>
                        
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">User Settings</summary>
                            <div id="userSettingsContent" style="padding: 1em; font-family: monospace; font-size: 11px; background: #2a2a2a; color: #d4d4d4; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">
                                <div style="color: #9cdcfe;">Click "Refresh Debug Data" to load...</div>
                            </div>
                        </details>
                        
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">User Section Types</summary>
                            <div id="userSectionTypesContent" style="padding: 1em; font-family: monospace; font-size: 11px; background: #2a2a2a; color: #d4d4d4; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">
                                <div style="color: #9cdcfe;">Click "Refresh Debug Data" to load...</div>
                            </div>
                        </details>
                    </div>
                </fieldset>
            </div>

            <br>
            <button id="btnSaveConfig" is="emby-button" type="submit" class="raised button-submit block emby-button">
                <span>Save</span>
            </button>
        </form>
    </div>

    <template id="sectionConfigTemplate">
        <tr data-id="section-config" class="section-expandable-row" tabindex="0" aria-expanded="false">
            <td style="text-align: left; vertical-align: middle; padding: 8px 12px; white-space:nowrap;">
                <input type="hidden" data-id="hiddenSectionId" />
                <strong class="section-name" title="Click to show/hide details" data-id="lblSectionName"></strong>
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <input data-id="txtOrderIndex" type="number" is="emby-input" min="0" class="emby-input" style="width: 60px; display: inline-table; text-align: center;">
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <div class="cell-center" style="display:flex;justify-content:center;align-items:center;width:100%;">
                    <label class="emby-checkbox-label" style="width:0;">
                        <input data-id="chkSectionEnabled" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel"></span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                        </span>
                    </label>
                </div>
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <div class="cell-center" style="display:flex;justify-content:center;align-items:center;width:100%;">
                    <label class="emby-checkbox-label" style="width:0;">
                        <input data-id="chkSectionUserOverrideAllowed" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel"></span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                        </span>
                    </label>
                </div>
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <input data-id="txtSectionMinLimit" type="number" is="emby-input" min="0" class="emby-input" style="width: 60px; display: inline-table; text-align: center;">
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <input data-id="txtSectionMaxLimit" type="number" is="emby-input" min="0" class="emby-input" style="width: 60px; display: inline-table; text-align: center;">
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <select is="emby-select" class="emby-select-withcolor emby-select" data-id="viewModeSelect" style="width: 100%; text-align: center;">
                    <option value="Portrait">Portrait</option>
                    <option value="Landscape">Landscape</option>
                    <option value="Square">Square</option>
                    <option value="Small">Small</option>
                </select>
            </td>
        </tr>
    </template>

    <template id="sectionDetailsTemplate">
        <tr class="section-details-row" data-id="section-details" style="display: none;">
            <td colspan="7" style="padding-top:6px;">
                <div class="details-wrapper-panel">
                    <div class="details-outer-container" data-id="detailsBox">
                        <div class="info-card" style="display: block; padding: .7em .85em .9em; margin: .35em 0 1em; border: 1px solid rgba(255,255,255,.18); border-radius: .55em; background: rgba(0,0,0,.25);">

                            <!-- Section Info Content -->
                            <div class="section-info-content" data-id="sectionInfoContent" style="display: none; margin-bottom: 1.5em;"></div>

                            <!-- Options Matrix -->
                            <div>
                                <table class="options-matrix" data-id="optionsMatrix" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                                    <thead>
                                    <tr>
                                        <th style="width: 25%;">Setting Name</th>
                                        <th style="width: 30%;">Admin Setting</th>
                                        <th class="col-override" style="text-align: center; width: 100px;">Allow User Override</th>
                                        <th class="col-desc" style="width: 35%;">Description</th>
                                        <th class="col-default" style="text-align: center; width: 10%;">Built-in Default</th>
                                    </tr>
                                    </thead>
                                    <tbody data-id="optionsMatrixBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </template>

    <script type="text/javascript">
        (() => {
            let HomeScreenSections = window.HomeScreenSections = {
                // Variables
                pluginId: 'b8298e01-2697-407a-b44d-aa8dc795e850',
                pluginAssemblyName: 'Jellyfin.Plugin.HomeScreenSections',
                sectionTemplate: null,
                sectionWrapper: null,
                btnSave: null,
                btnBustHomeSectionsCache: null,
                btnBustAllCaches: null,
                cacheBustStatus: null,

                // Centralized Arr service configuration
                arrServiceConfigs: [
                    { name: 'Sonarr', timeframePrefix: 'upcomingShows', defaultValue: 1, defaultUnit: 'Weeks' },
                    { name: 'Radarr', timeframePrefix: 'upcomingMovies', defaultValue: 3, defaultUnit: 'Months' },
                    { name: 'Lidarr', timeframePrefix: 'upcomingMusic', defaultValue: 6, defaultUnit: 'Months' },
                    { name: 'Readarr', timeframePrefix: 'upcomingBooks', defaultValue: 1, defaultUnit: 'Years' }
                ],
                
                // Functions
                init: function () {
                    HomeScreenSections.sectionTemplate = document.querySelector('#sectionConfigTemplate');
                    HomeScreenSections.sectionWrapper = document.querySelector('#sectionWrapper');
                    HomeScreenSections.btnSave = document.querySelector('#btnSaveConfig');

                    HomeScreenSections.btnBustHomeSectionsCache = document.querySelector('#btnBustHomeSectionsCache');
                    HomeScreenSections.btnBustAllCaches = document.querySelector('#btnBustAllCaches');
                    HomeScreenSections.cacheBustStatus = document.getElementById('cacheBustStatus');

                    window.HomeScreenSectionsDebugFetch = () => fetch(window.ApiClient.getUrl('HomeScreen/Configuration'), { 
                        headers: {
                            'Accept': 'application/json' 
                        }
                    }).then(r => r.json()).then(j => { 
                        console.log('Direct /HomeScreen/Configuration', j); 
                        return j; 
                    });
                    
                    HomeScreenSections.setupTabs();
                    HomeScreenSections.loadConfig();
                    HomeScreenSections.loadLibraries();
                },
                initEvents: function () {
                    // Event listeners setup
                    const eventBindings = {
                        '#btnSaveConfig': () => HomeScreenSections.saveConfig,
                        '#btnExpandAllSections': () => () => HomeScreenSections.expandAll(),
                        '#btnCollapseAllSections': () => () => HomeScreenSections.collapseAll(),
                        '#adminShowAdvanced': (el) => function() {
                            const enabled = !!this.checked;
                            localStorage.setItem('homeScreenSections.admin.showAdvanced', enabled ? 'true' : 'false');
                            HomeScreenSections.applyAdvancedToggle(enabled);
                        },
                        '#btnRefreshDebug': () => HomeScreenSections.loadDebugData
                    };

                    Object.entries(eventBindings).forEach(([selector, handlerFn]) => {
                        const el = document.querySelector(selector);
                        if (el) {
                            if (selector === '#btnSaveConfig') {
                                el.removeEventListener('click', HomeScreenSections.saveConfig);
                            }
                            el.addEventListener('click', handlerFn(el));
                        }
                    });
                },
                initCacheBust: function () {
                    // Cache bust functionality
                    if (HomeScreenSections.btnBustHomeSectionsCache) {
                        const originalText = HomeScreenSections.btnBustHomeSectionsCache.querySelector('span').textContent;
                        HomeScreenSections.btnBustHomeSectionsCache.addEventListener('click', function() {
                            HomeScreenSections.setButtonState(HomeScreenSections.btnBustHomeSectionsCache, true, originalText);

                            window.ApiClient.ajax({
                                url: window.ApiClient.getUrl('HomeScreen/BustCache'),
                                type: 'POST',
                                dataType: 'json',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                }
                            }).then(response => {
                                HomeScreenSections.showStatus('Static assets cache busted successfully');
                            }).catch(error => {
                                console.error('Static assets cache bust error:', error);
                                HomeScreenSections.showStatus('Failed to bust static assets cache', true);
                            }).finally(() => {
                                HomeScreenSections.setButtonState(HomeScreenSections.btnBustHomeSectionsCache, false, originalText);
                            });
                        });
                    }

                    if (HomeScreenSections.btnBustAllCaches) {
                        const originalText = HomeScreenSections.btnBustAllCaches.querySelector('span').textContent;
                        HomeScreenSections.btnBustAllCaches.addEventListener('click', function() {
                            HomeScreenSections.setButtonState(HomeScreenSections.btnBustAllCaches, true, originalText);

                            // First bust static assets cache (Home Sections)
                            const staticAssetsPromise = window.ApiClient.ajax({
                                url: window.ApiClient.getUrl('HomeScreen/BustCache'),
                                type: 'POST',
                                dataType: 'json',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                }
                            });

                            // Then bust index.html transformation cache (for home-sections plugin assembly name)
                            const indexTransformPromise = window.ApiClient.ajax({
                                url: window.ApiClient.getUrl('TransformationCache/bust-cache?pluginName=' + encodeURIComponent(pluginAssemblyName)),
                                type: 'POST',
                                dataType: 'json',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                }
                            });

                            Promise.allSettled([staticAssetsPromise, indexTransformPromise]).then(results => {
                                const staticResult = results[0];
                                const transformResult = results[1];

                                let message = '';
                                let isError = false;

                                if (staticResult.status === 'fulfilled' && transformResult.status === 'fulfilled') {
                                    message = 'All caches busted successfully (assets + index)';
                                } else if (staticResult.status === 'fulfilled' && transformResult.status === 'rejected') {
                                    console.warn('Transformation cache bust failed:', transformResult.reason);
                                    if (transformResult.reason?.status === 404) {
                                        message = 'Static assets cache busted - file-transformation plugin not found or plugin not registered';
                                    } else {
                                        message = 'Static assets cache busted - file-transformation cache failed (check console)';
                                    }
                                } else if (staticResult.status === 'rejected') {
                                    console.error('Static assets cache bust failed:', staticResult.reason);
                                    message = 'Failed to bust static assets cache';
                                    isError = true;
                                } else {
                                    message = 'Cache bust completed with mixed results (check console)';
                                }

                                HomeScreenSections.showStatus(message, isError);
                            }).finally(() => {
                                HomeScreenSections.setButtonState(HomeScreenSections.btnBustAllCaches, false, originalText);
                            });
                        });
                    }
                },
                setupTabs: function () {
                    const tabs = document.querySelectorAll('.jellyfin-tab-button');
                    const tabContents = document.querySelectorAll('.jellyfin-tab-content');
                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            tabs.forEach(t => {
                                t.classList.remove('active');
                                t.style.color = '#ccc';
                                t.style.borderBottom = '2px solid transparent';
                            });
                            tab.classList.add('active');
                            tab.style.color = 'var(--primary-accent-color, #fff)';
                            tab.style.borderBottom = '2px solid var(--primary-accent-color, #fff)';
                            tabContents.forEach(content => {
                                content.classList.remove('active');
                                content.style.display = 'none';
                            });
                            const activeTab = document.getElementById(tab.dataset.tab);
                            activeTab.classList.add('active');
                            activeTab.style.display = 'block';
                        });
                    });
                },
                loadLibraries: function () {
                    window.ApiClient.getVirtualFolders().then(function (result) {
                        const selects = {
                            movies: document.querySelector('#defaultMoviesLibrary'),
                            tvshows: document.querySelector('#defaultTVShowsLibrary'),
                            music: document.querySelector('#defaultMusicLibrary'),
                            books: document.querySelector('#defaultBooksLibrary')
                        };

                        // Clear existing options
                        Object.values(selects).forEach(select => {
                            while (select.options.length > 1) select.remove(1);
                        });

                        function addOption(select, folder) {
                            const opt = document.createElement('option');
                            let folderId = folder.ItemId;
                            if (folderId && folderId.indexOf('-') === -1) {
                                folderId = folderId.replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/, '$1-$2-$3-$4-$5');
                            }
                            opt.value = folderId;
                            opt.textContent = folder.Name;
                            select.appendChild(opt);
                        }

                        result.forEach(function(f) {
                            if (f.CollectionType === 'movies') {
                                addOption(selects.movies, f);
                            }
                            if (f.CollectionType === 'tvshows') {
                                addOption(selects.tvshows, f);
                            }
                            if(f.CollectionType === 'music') {
                                addOption(selects.music, f);
                            }
                            if(f.CollectionType === 'books') {
                                addOption(selects.books, f);
                            }
                        });
                    }).catch(function (error) {
                        console.error('Failed to load libraries:', error);
                    });
                },
                loadConfig: function () {
                    Dashboard.showLoadingMsg();
                    window.ApiClient.getPluginConfiguration(HomeScreenSections.pluginId) .then(function (config) {
                        try {
                            console.group('HomeScreenSections LOAD');
                            console.log('Raw plugin configuration', config);
                            if (Array.isArray(config.SectionSettings)) {
                                config.SectionSettings.forEach(function(s,i){
                                    console.log('SectionSettings['+i+']', s.SectionId, s);
                                });
                            }
                            console.groupEnd();
                        } catch(_) {}

                        // Set form values
                        const formFields = {
                            '#globalEnabledDefault': config.Enabled,
                            '#globalAllowUserOverride': config.AllowUserOverride,
                            '[data-id=txtLibreTranslateUrl]': config.LibreTranslateUrl,
                            '[data-id=txtLibreTranslateApiKey]': config.LibreTranslateApiKey,
                            '[data-id=txtJellyseerrUrl]': config.JellyseerrUrl,
                            '[data-id=txtJellyseerrApiKey]': config.JellyseerrApiKey,
                            '[data-id=txtJellyseerrPreferredLanguages]': config.JellyseerrPreferredLanguages,
                            
                            '#defaultMoviesLibrary': config.DefaultMoviesLibraryId,
                            '#defaultTVShowsLibrary': config.DefaultTVShowsLibraryId,
                            '#defaultMusicLibrary': config.DefaultMusicLibraryId,
                            '#defaultBooksLibrary': config.DefaultBooksLibraryId,
                            
                            '#dateFormat': config.DateFormat || 'YYYY/MM/DD',
                            '#dateDelimiter': config.DateDelimiter || '/',
                            '#globalStreamyfinHomeOverride': config.OverrideStreamyfinHome,
                            '#globalDeveloperMode': config.DeveloperMode,
                            '[data-id=txtCacheTimeoutSeconds]': config.CacheTimeoutSeconds || 86400
                        };

                        Object.entries(formFields).forEach(([selector, value]) => {
                            const el = document.querySelector(selector);
                            if (el) {
                                if (el.type === 'checkbox') {
                                    el.checked = !!value;
                                } else {
                                    el.value = value || '';
                                }
                            }
                        });
                        
                        HomeScreenSections.arrServiceConfigs.forEach(serviceConfig => {
                            HomeScreenSections.loadArrConfig(serviceConfig, config);
                        });

                        window.ApiClient.fetch({
                            url: window.ApiClient.getUrl('ModularHomeViews/Admin/SectionTypes'),
                            type: 'GET',
                            dataType: 'json',
                            headers: { accept: 'application/json' }
                        }).then(function (resp) {
                            const json = resp || {};
                            const items = json.Items || json || [];
                            HomeScreenSections.loadConfigResponse(config, items);
                        }).catch(function (err) {
                            console.error('Failed to fetch sections:', err);
                            Dashboard.hideLoadingMsg();
                        });
                    });
                },

                loadConfigResponse: function (pluginConfig, sectionTypes) {
                    HomeScreenSections.sectionWrapper.innerHTML = '';
                    const existing = pluginConfig.SectionSettings || [];
                    const map = Object.fromEntries(existing.map(s => [s.SectionId, s]));

                    const pending = sectionTypes
                        .map(info => {
                            const sectionId = info.Section || info.SectionId || info.Id;
                            if (!sectionId) return null;

                            let cfg = map[sectionId] || {
                                SectionId: sectionId,
                                Enabled: true,
                                AllowUserOverride: true,
                                LowerLimit: 1,
                                UpperLimit: info.Limit || 0,
                                ViewMode: info.ViewMode || 'Portrait',
                                OrderIndex: 999,
                                PluginConfigurations: [],
                                UserOverrideSettings: []
                            };

                            if (!Array.isArray(cfg.UserOverrideSettings)) cfg.UserOverrideSettings = [];
                            cfg.OrderIndex = parseInt(cfg.OrderIndex, 10) || 999;
                            return { cfg, info };
                        })
                        .filter(Boolean)
                        .sort((a,b) => {
                            if (a.cfg.OrderIndex !== b.cfg.OrderIndex) return a.cfg.OrderIndex - b.cfg.OrderIndex;
                            return (a.cfg.SectionId || '').localeCompare(b.cfg.SectionId || '');
                        });

                    pending.forEach(p => HomeScreenSections.addSectionSetting(p.cfg, p.info));

                    const adv = document.querySelector('#adminShowAdvanced');
                    const saved = localStorage.getItem('homeScreenSections.admin.showAdvanced') === 'true';
                    if (adv) adv.checked = saved;
                    HomeScreenSections.applyAdvancedToggle(saved);
                    Dashboard.hideLoadingMsg();
                },
                
                addSectionSetting: function (sectionConfig, sectionInfo) {
                    const H = window.HSSShared || {};

                    const rowFrag = HomeScreenSections.sectionTemplate.cloneNode(true).content;
                    rowFrag.querySelector('[data-id=hiddenSectionId]').value = sectionConfig.SectionId;
                    rowFrag.querySelector('[data-id=chkSectionEnabled]').checked = !!sectionConfig.Enabled;
                    rowFrag.querySelector('[data-id=chkSectionUserOverrideAllowed]').checked = (sectionConfig.AllowUserOverride !== false);
                    rowFrag.querySelector('[data-id=txtSectionMinLimit]').value = sectionConfig.LowerLimit || 0;
                    rowFrag.querySelector('[data-id=txtSectionMaxLimit]').value = sectionConfig.UpperLimit || 0;
                    rowFrag.querySelector('[data-id=txtOrderIndex]').value = sectionConfig.OrderIndex || 0;
                    const viewSel = rowFrag.querySelector('[data-id=viewModeSelect]');
                    viewSel.value = sectionConfig.ViewMode || 'Portrait';
                    if (sectionInfo && sectionInfo.AllowViewModeChange === false) {
                        viewSel.value = sectionInfo.ViewMode || viewSel.value;
                        viewSel.setAttribute('disabled', 'true');
                    } else if (sectionInfo && Array.isArray(sectionInfo.SupportedViewModes) && sectionInfo.SupportedViewModes.length) {
                        const allowed = {};
                        sectionInfo.SupportedViewModes.forEach(function (v) { allowed[v] = true; });
                        Array.prototype.forEach.call(viewSel.options, function (opt) { opt.hidden = !allowed[opt.value]; });
                        if (!allowed[viewSel.value]) viewSel.value = sectionInfo.SupportedViewModes[0];
                    }
                    rowFrag.querySelector('[data-id=lblSectionName]').textContent = (sectionInfo && sectionInfo.DisplayText) || sectionConfig.SectionId;
                    HomeScreenSections.sectionWrapper.appendChild(rowFrag);

                    const mainRow = HomeScreenSections.sectionWrapper.lastElementChild;
                    const detailsFrag = document.querySelector('#sectionDetailsTemplate').content.cloneNode(true);
                    HomeScreenSections.sectionWrapper.appendChild(detailsFrag);
                    const detailsRow = mainRow.nextElementSibling;

                    const infoContent = detailsRow.querySelector('[data-id=sectionInfoContent]');

                    if (infoContent && sectionInfo && sectionInfo.Info) {
                        let infoHtml = '';

                        infoHtml = H.buildSectionInfo(sectionInfo, { isAdmin: true });

                        if (infoHtml) {
                            infoContent.innerHTML = infoHtml;
                            infoContent.style.display = 'block';
                        }
                    }

                    const nameClickable = mainRow.querySelector('[data-id=lblSectionName]');

                    function toggleDetails(force) {
                        const show = force !== undefined ? force : detailsRow.style.display === 'none';
                        detailsRow.style.display = show ? '' : 'none';
                        mainRow.classList.toggle('expanded', show);
                        mainRow.setAttribute('aria-expanded', show ? 'true' : 'false');

                        const sectionName = mainRow.querySelector('[data-id=lblSectionName]');
                        if (sectionName) {
                            sectionName.setAttribute('title', show ? 'Click to hide details' : 'Click to show details');
                        }
                    }
                    nameClickable.addEventListener('click', function (e) { e.stopPropagation(); toggleDetails(); });
                    mainRow.addEventListener('click', function (e) {
                        if (e.target.closest('input,select,option,label,.checkboxOutline')) return;
                        toggleDetails();
                    });
                    mainRow._toggleDetails = toggleDetails;

                    if (HomeScreenSections.addHoverEffects) {
                        HomeScreenSections.addHoverEffects(mainRow);
                    } else {
                        console.warn('Shared hover effects not available');
                    }

                    const originalToggle = mainRow._toggleDetails;
                    mainRow._toggleDetails = function(force) {
                        let sectionName;
                        let tds;
                        originalToggle.call(this, force);
                        const isExpanded = mainRow.classList.contains('expanded');

                        if (isExpanded) {
                            tds = mainRow.querySelectorAll('td');
                            tds.forEach(function(td) {
                                td.style.backgroundColor = '#2a2a2a';
                            });

                            sectionName = mainRow.querySelector('.section-name');
                            if (sectionName) {
                                sectionName.style.fontWeight = '600';
                                sectionName.style.color = 'var(--theme-primary-color, #00a4dc)';
                            }
                        } else {
                            tds = mainRow.querySelectorAll('td');
                            tds.forEach(function(td) {
                                td.style.backgroundColor = '';
                            });

                            sectionName = mainRow.querySelector('.section-name');
                            if (sectionName) {
                                sectionName.style.fontWeight = '';
                                sectionName.style.color = '';
                            }
                        }
                    };

                    const masterCb = mainRow.querySelector('[data-id=chkSectionUserOverrideAllowed]');

                    function applyMasterOverrideState(isUserInteraction) {
                        const matrix = detailsRow;
                        const allOverrideInputs = detailsRow.querySelectorAll('input[type="checkbox"][data-config-override]');
                        const overrideCells = detailsRow.querySelectorAll('td.col-override');

                        if (!masterCb.checked) {
                            // Master disabled: Hide all override controls
                            matrix.classList.add('hide-overrides');
                            for (let i = 0; i < allOverrideInputs.length; i++) {
                                allOverrideInputs[i].checked = false;
                                allOverrideInputs[i].disabled = true;
                            }
                            overrideCells.forEach(function (td) {
                                const labelEl = td.querySelector('.emby-checkbox-label');
                                const inputEl = td.querySelector('input[is="emby-checkbox"], input.emby-checkbox');
                                const outlineEl = td.querySelector('.checkboxOutline');
                                if (labelEl) labelEl.style.display = 'none';
                                if (inputEl) inputEl.style.display = 'none';
                                if (outlineEl) outlineEl.style.display = 'none';
                            });
                        } else {
                            // Master enabled: Show all override controls
                            matrix.classList.remove('hide-overrides');
                            const perOption = detailsRow.querySelectorAll('input[type="checkbox"][data-config-override]');
                            for (let j = 0; j < perOption.length; j++) {
                                const input = perOption[j];
                                const disallowed = input.getAttribute('data-disallow') === 'true';
                                if (disallowed) {
                                    // Some settings can't be overridden
                                    input.disabled = true;
                                    input.checked = false;
                                    const labelElX = input.closest('label.emby-checkbox-label');
                                    const outlineElX = labelElX ? labelElX.querySelector('.checkboxOutline') : null;
                                    if (labelElX) labelElX.style.display = 'none';
                                    if (outlineElX) outlineElX.style.display = 'none';
                                } else {
                                    input.disabled = false;
                                    if (isUserInteraction) {
                                        input.checked = true;
                                    }
                                }
                            }

                            overrideCells.forEach(function (td) {
                                const labelEl = td.querySelector('.emby-checkbox-label');
                                const inputEl = td.querySelector('input[is="emby-checkbox"], input.emby-checkbox');
                                const outlineEl = td.querySelector('.checkboxOutline');
                                if (labelEl && labelEl.getAttribute('data-override-disallowed') === 'true') {
                                    labelEl.style.display = 'none';
                                } else if (labelEl) {
                                    labelEl.style.display = '';
                                }
                                if (inputEl) inputEl.style.display = '';
                                if (outlineEl) outlineEl.style.display = '';
                            });
                        }
                    }
                    masterCb.addEventListener('change', function() { applyMasterOverrideState(true); });

                    HomeScreenSections.populateDynamicConfigOptions(detailsRow, sectionConfig).then(function () {
                        const H = window.HSSShared || {};
                        if (H.attachUnifiedValidation) {
                            H.attachUnifiedValidation(detailsRow, { toast:true, color:true });
                        }

                        applyMasterOverrideState(false);
                    });
                },
                saveConfig: function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();

                    const H = window.HSSShared || {};

                    const config = {
                        Enabled: document.querySelector('#globalEnabledDefault').checked,
                        AllowUserOverride: document.querySelector('#globalAllowUserOverride').checked,
                        LibreTranslateUrl: document.querySelector('[data-id=txtLibreTranslateUrl]').value,
                        LibreTranslateApiKey: document.querySelector('[data-id=txtLibreTranslateApiKey]').value,
                        JellyseerrUrl: document.querySelector('[data-id=txtJellyseerrUrl]').value,
                        JellyseerrApiKey: document.querySelector('[data-id=txtJellyseerrApiKey]').value,
                        JellyseerrPreferredLanguages: document.querySelector('[data-id=txtJellyseerrPreferredLanguages]').value,
                        DefaultMoviesLibraryId: document.querySelector('#defaultMoviesLibrary').value,
                        DefaultTVShowsLibraryId: document.querySelector('#defaultTVShowsLibrary').value,
                        DefaultMusicLibraryId: document.querySelector('#defaultMusicLibrary').value,
                        DefaultBooksLibraryId: document.querySelector('#defaultBooksLibrary').value,
                        ...Object.fromEntries(HomeScreenSections.arrServiceConfigs.map(serviceConfig => [
                            serviceConfig.name,
                            HomeScreenSections.createArrConfig(serviceConfig)
                        ])),
                        DateFormat: document.querySelector('#dateFormat').value,
                        DateDelimiter: document.querySelector('#dateDelimiter').value,
                        DeveloperMode: document.querySelector('#globalDeveloperMode').checked,
                        CacheTimeoutSeconds: document.querySelector('[data-id=txtCacheTimeoutSeconds]').value || 86400,
                        OverrideStreamyfinHome: document.querySelector('#globalStreamyfinHomeOverride').checked,
                        SectionSettings: []
                    };

                    const rows = document.querySelectorAll('[data-id=section-config]');
                    rows.forEach(row => {
                        let validation;
                        const sectionId = row.querySelector('[data-id=hiddenSectionId]').value;
                        const detailsRow = (row.nextElementSibling && row.nextElementSibling.getAttribute('data-id') === 'section-details') ? row.nextElementSibling : null;

                        const sectionConfig = {
                            SectionId: sectionId,
                            Enabled: row.querySelector('[data-id=chkSectionEnabled]').checked,
                            AllowUserOverride: row.querySelector('[data-id=chkSectionUserOverrideAllowed]').checked,
                            LowerLimit: row.querySelector('[data-id=txtSectionMinLimit]').value,
                            UpperLimit: row.querySelector('[data-id=txtSectionMaxLimit]').value,
                            OrderIndex: row.querySelector('[data-id=txtOrderIndex]').value,
                            ViewMode: row.querySelector('[data-id=viewModeSelect]').value,
                            HideWatchedItems: row.querySelector('[data-id=chkHideWatchedItems]').checked,
                            PluginConfigurations: [],
                            UserOverrideSettings: []
                        };
                        
                        if (detailsRow) {
                            if (H.validateAndCollectInputs) {
                                validation = H.validateAndCollectInputs(detailsRow);
                                if (!validation.valid) {
                                    Dashboard.hideLoadingMsg();
                                    Dashboard.alert(validation.message || 'Please fix invalid inputs before saving.');
                                    throw new Error('Validation failed');
                                }
                            }

                            let configurationValues = [];
                            if (window.HSSShared && window.HSSShared.validateAndCollectInputs) {
                                validation = window.HSSShared.validateAndCollectInputs(detailsRow);
                                if (validation.isValid) {
                                    configurationValues = validation.collected;
                                } else {
                                    console.warn('Validation failed, using basic collection');
                                    configurationValues = H.collectOptionValues ? H.collectOptionValues(detailsRow) : [];
                                }
                            } else {
                                console.warn('Shared utilities not available, using basic collection');
                                configurationValues = H.collectOptionValues ? H.collectOptionValues(detailsRow) : [];
                            }

                            if (!Array.isArray(configurationValues)) configurationValues = [];

                            const idxEnabledSynth = configurationValues.findIndex(function (pc) {
                                return pc && pc.Key === 'Enabled';
                            });
                            if (idxEnabledSynth === -1) {
                                configurationValues.push({ Key:'Enabled', Value: sectionConfig.Enabled, Type:'bool' });
                            } else {
                                configurationValues[idxEnabledSynth].Value = sectionConfig.Enabled;
                            }

                            const masterCbForSave = row.querySelector('[data-id=chkSectionUserOverrideAllowed]');
                            const masterEnabledForSave = !!masterCbForSave?.checked;
                            const storedStates = detailsRow._storedOverrideStates || [];
                            const overrideCheckboxes = detailsRow.querySelectorAll('input[type="checkbox"][data-config-override]');

                            const masterOverride = !!row.querySelector('[data-id=chkSectionUserOverrideAllowed]')?.checked;

                            overrideCheckboxes.forEach(function (ocb) {
                                if (ocb.getAttribute('data-disallow') === 'true') return;
                                const oKey = ocb.getAttribute('data-config-override');
                                if (!oKey) return;

                                const effectiveChecked = masterEnabledForSave ?
                                    (storedStates.length && !masterEnabledForSave ?
                                        (storedStates.find(r => r.el === ocb)?.checked || false) :
                                        ocb.checked) : false;

                                const existingConfig = configurationValues.find(cv => cv?.Key === oKey);
                                if (existingConfig) {
                                    existingConfig.AllowUserOverride = effectiveChecked;
                                } else {
                                    configurationValues.push({
                                        Key: oKey,
                                        Value: null,
                                        Type: "System.Object",
                                        AllowUserOverride: effectiveChecked
                                    });
                                }
                            });

                            // Store the unified configuration
                            sectionConfig.PluginConfigurations = configurationValues;
                        }
                        
                        config.SectionSettings.push(sectionConfig);
                    });

                    window.ApiClient.updatePluginConfiguration(HomeScreenSections.pluginId, config)
                        .then(Dashboard.processPluginConfigurationUpdateResult)
                        .catch(e => console.error(e))
                        .finally(() => Dashboard.hideLoadingMsg());
                },

                // Commented because its unused
                // validateDetailsRow: function (detailsRow) {
                //     var H = window.HSSShared || {};
                //     return (H.validateInputs) ? H.validateInputs(detailsRow) : { valid: true };
                // },
                
                createArrConfig: function (serviceConfig) {
                    const timeframeValueSelector = '#' + serviceConfig.timeframePrefix + 'TimeframeValue';
                    return {
                        Url: document.querySelector('[data-id=txt' + serviceConfig.name + 'Url]').value,
                        ApiKey: document.querySelector('[data-id=txt' + serviceConfig.name + 'ApiKey]').value,
                        UpcomingTimeframeValue: parseInt(document.querySelector(timeframeValueSelector).value) || serviceConfig.defaultValue,
                        UpcomingTimeframeUnit: document.querySelector('#' + serviceConfig.timeframePrefix + 'TimeframeUnit').value
                    };
                },
                loadArrConfig: function (serviceConfig, config) {
                    const arrConfig = config[serviceConfig.name];
                    const timeframeValueSelector = '#' + serviceConfig.timeframePrefix + 'TimeframeValue';
                    const timeframeUnitSelector = '#' + serviceConfig.timeframePrefix + 'TimeframeUnit';

                    document.querySelector('[data-id=txt' + serviceConfig.name + 'Url]').value = arrConfig?.Url || '';
                    document.querySelector('[data-id=txt' + serviceConfig.name + 'ApiKey]').value = arrConfig?.ApiKey || '';
                    document.querySelector(timeframeValueSelector).value = arrConfig?.UpcomingTimeframeValue || serviceConfig.defaultValue;
                    document.querySelector(timeframeUnitSelector).value = arrConfig?.UpcomingTimeframeUnit || serviceConfig.defaultUnit;
                },

                showStatus: function(message, isError = false) {
                    if (HomeScreenSections.cacheBustStatus) {
                        HomeScreenSections.cacheBustStatus.textContent = message;
                        HomeScreenSections.cacheBustStatus.style.color = isError ? '#d32f2f' : '#52b54b';
                        HomeScreenSections.cacheBustStatus.style.display = 'inline';
                        setTimeout(() => HomeScreenSections.cacheBustStatus.style.display = 'none', 4000);
                    }
                },

                setButtonState: function(button, loading, originalText) {
                    button.disabled = loading;
                    button.querySelector('span').textContent = loading ? 'Busting Cache...' : originalText;
                },
                expandAll: function(){
                    const rows = HomeScreenSections.sectionWrapper.querySelectorAll('[data-id=section-config]');
                    rows.forEach(function(r){ if (typeof r._toggleDetails === 'function') r._toggleDetails(true); });
                },
                collapseAll: function(){
                    const rows = HomeScreenSections.sectionWrapper.querySelectorAll('[data-id=section-config]');
                    rows.forEach(function(r){ if (typeof r._toggleDetails === 'function') r._toggleDetails(false); });
                },

                applyAdvancedToggle: function (enabled) {
                    const nodes = document.querySelectorAll('.advanced-options');
                    for (let i = 0; i < nodes.length; i++) {
                        const el = nodes[i];
                        if (enabled) {
                            el.classList.add('show');
                            el.style.display = '';
                        } else {
                            el.classList.remove('show');
                            el.style.display = 'none';
                        }
                    }
                },

                populateDynamicConfigOptions: async function (detailsRow, sectionConfig) {
                    try {
                        const matrixBody = detailsRow.querySelector('[data-id=optionsMatrixBody]');
                        if (!matrixBody) return;
                        matrixBody.innerHTML = '';
                        const sectionId = sectionConfig.SectionId;
                        const relativeApi = 'HomeScreen/Admin/Section/' + encodeURIComponent(sectionId);
                        const url = window.ApiClient.getUrl(relativeApi);
                        let options = [];
                        try {
                            const resp = await window.ApiClient.fetch({
                                url: url,
                                type: 'GET',
                                dataType: 'json',
                                headers: {accept: 'application/json'}
                            });
                            if (Array.isArray(resp)) {
                                options = resp;
                            } else if (resp && Array.isArray(resp.Items)) {
                                options = resp.Items;
                            } else if (resp) {
                                options = resp;
                            }
                            if (!Array.isArray(options)) options = [];
                        } catch (e) {
                            try {
                                const token = (window.ApiClient.accessToken && window.ApiClient.accessToken()) || (window.ApiClient._accessToken || '');
                                const rawResp = await fetch(url, {
                                    headers: {
                                        accept: 'application/json',
                                        'X-Emby-Token': token
                                    }
                                });
                                if (rawResp.ok) {
                                    options = await rawResp.json();
                                    if (!Array.isArray(options)) options = [];
                                } else {
                                    console.warn('[AdminConfig] ConfigurationOptions fetch failed', { url: url, status: rawResp.status, statusText: rawResp.statusText });
                                    try {
                                        const txt2 = await rawResp.text();
                                        console.warn('[AdminConfig] Response body snippet:', txt2.slice(0,250)); } catch(_) {}
                                }
                            } catch (e2) {
                                console.error('[AdminConfig] Fetch exception (both methods failed)', e, e2);
                            }
                        }

                        const valueMap = {};
                        if (Array.isArray(sectionConfig.PluginConfigurations)) {
                            sectionConfig.PluginConfigurations.forEach(function (pc) { valueMap[pc.Key] = pc; });
                        }
                        function isGranted(key){
                            // Read AllowUserOverride from unified PluginConfigurations system
                            if (!key || !Array.isArray(sectionConfig.PluginConfigurations)) return false;
                            for (let i = 0; i < sectionConfig.PluginConfigurations.length; i++) {
                                const pc = sectionConfig.PluginConfigurations[i];
                                if (!pc || pc.Key !== key) continue;
                                return !!pc.AllowUserOverride;
                            }
                            return false;
                        }

                        const showAdvanced = localStorage.getItem('homeScreenSections.admin.showAdvanced') === 'true';

                        let H = window.HSSShared || {};
                        options.forEach(function(opt){
                            if(!opt || !opt.Key) return;
                            const curRec = valueMap[opt.Key];
                            const curValue = (curRec && curRec.Value !== undefined) ? curRec.Value : opt.DefaultValue;

                            const inputHtml = H.buildAdminOptionInput ? H.buildAdminOptionInput(opt, curValue) : '';
                            if (!inputHtml) return;

                            const intrinsic = !!opt.AllowUserOverride;
                            const grantChecked = isGranted(opt.Key);
                            const overrideCbAttrs = ' data-config-override="' + (H.escapeAttr ? H.escapeAttr(opt.Key) : opt.Key) + '"' + (intrinsic ? (grantChecked ? ' checked' : '') : ' data-disallow="true"');
                            const overrideLabelExtra = intrinsic ? '' : ' data-override-disallowed="true"';

                            const overrideCellContent = '<div class="cell-center" style="display:flex;justify-content:center;align-items:center;width:100%;"><label class="emby-checkbox-label" style="width:0;"' + overrideLabelExtra + '>'
                                + '<input type="checkbox" is="emby-checkbox" class="emby-checkbox"' + overrideCbAttrs + '>'
                                + '<span class="checkboxLabel"></span>'
                                + '<span class="checkboxOutline">'
                                + '<span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>'
                                + '<span class="material-icons checkboxIcon checkboxIcon-unchecked "></span>'
                                + '</span></label></div>';

                            const advancedCls = (opt.Advanced || opt.IsAdvanced) ? 'advanced-options' : '';
                            let defVal = (opt.DefaultValue === undefined || opt.DefaultValue === null) ? '' : String(opt.DefaultValue);

                            // Convert dropdown key to label for display using shared utility
                            defVal = H.convertDropdownKeyToLabel ? H.convertDropdownKeyToLabel(opt, defVal) : defVal;

                            const desc = opt.Description || '';
                            const rowHtml = '<tr class="' + advancedCls + '"' + (((opt.Advanced || opt.IsAdvanced) && !showAdvanced) ? ' style="display:none;"' : '') + '>'
                                + '<td class="name-cell">' + (H.escapeHtml ? H.escapeHtml(opt.Name || opt.Label || opt.Key) : (opt.Name || opt.Label || opt.Key)) + '</td>'
                                + '<td style="text-align: center; vertical-align: middle; padding: 8px 12px;"><div class="cell-center" style="display:flex;justify-content:center;align-items:center;width:100%;">' + inputHtml + '</div></td>'
                                + '<td class="col-override" style="text-align: center; vertical-align: middle; padding: 8px 12px;">' + overrideCellContent + '</td>'
                                + '<td class="col-desc">' + (H.escapeHtml ? H.escapeHtml(desc) : desc) + '</td>'
                                + '<td class="col-default"><div class="cell-center">' + (H.escapeHtml ? H.escapeHtml(defVal) : defVal) + '</div></td>'
                                + '</tr>';

                            matrixBody.insertAdjacentHTML('beforeend', rowHtml);
                        });

                        setTimeout(function(){
                            try {
                                const overrideInputs = matrixBody.querySelectorAll('input[type="checkbox"][data-config-override]');
                                overrideInputs.forEach(function(inp){
                                    const key = inp.getAttribute('data-config-override');
                                    if (!key) return;
                                    if (isGranted(key)) {
                                        inp.checked = true;
                                    } else if (inp.getAttribute('data-disallow') === 'true') {
                                        inp.checked = false;
                                    }
                                });
                                const mainEnabledCb = detailsRow.previousElementSibling?.querySelector('[data-id=chkSectionEnabled]');
                                const synthEnabled = matrixBody.querySelector('input.pluginConfig[data-config-key="Enabled"]');
                                if (mainEnabledCb && synthEnabled) {
                                    synthEnabled.checked = !!mainEnabledCb.checked;
                                    if (!synthEnabled._boundSync) {
                                        mainEnabledCb.addEventListener('change', function(){ synthEnabled.checked = mainEnabledCb.checked; });
                                        synthEnabled.addEventListener('change', function(){ mainEnabledCb.checked = synthEnabled.checked; });
                                        synthEnabled._boundSync = true;
                                    }
                                }
                            } catch(stabErr) {
                                console.warn('Stabilization pass error', stabErr);
                            }
                        }, 0);

                        H = window.HSSShared || {};
                        if (H.attachUnifiedValidation) {
                            H.attachUnifiedValidation(detailsRow);
                        }

                    } catch (err) {
                        console.error('populateDynamicConfigOptions error:', err);
                    }
                },

                populateUserOverrideSettings: function () {},
                addHoverEffects: function(row) {
                    row.addEventListener('mouseenter', function() {
                        const cells = this.querySelectorAll('td');
                        cells.forEach(function(td) {
                            td.style.backgroundColor = '#242424';
                            td.style.transition = 'background-color 0.2s ease';
                        });
                    });
    
                    row.addEventListener('mouseleave', function() {
                        if (!this.classList.contains('expanded')) {
                            const cells = this.querySelectorAll('td');
                            cells.forEach(function(td) {
                                td.style.backgroundColor = '';
                            });
                        }
                    });
                },

                loadDebugData: function() {
                    const containers = {
                        adminConfigContent: 'Loading...',
                        adminSectionTypesContent: 'Loading...',
                        userSelectorControls: 'Loading users...',
                        userSettingsContent: 'Loading...',
                        userSectionTypesContent: 'Loading...'
                    };
    
                    Object.entries(containers).forEach(([id, msg]) => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = `<div style="color: #9cdcfe;">${msg}</div>`;
                    });
    
                    const debugData = {};
                    const apiCalls = [
                        { key: 'pluginConfiguration', call: () => window.ApiClient.getPluginConfiguration(HomeScreenSections.pluginId) },
                        { key: 'sectionTypes', call: () => window.ApiClient.fetch({
                                url: window.ApiClient.getUrl('ModularHomeViews/Admin/SectionTypes'),
                                type: 'GET', dataType: 'json', headers: { accept: 'application/json' }
                            })},
                        { key: 'availableUsers', call: () => window.ApiClient.getUsers() }
                    ];
    
                    apiCalls.forEach(({key, call}) => {
                        call().then(data => {
                            debugData[key] = key === 'sectionTypes' ? (data?.Items || data || []) : data;
                            updateDebugDisplay();
    
                            // After loading users, load data for the current user
                            if (key === 'availableUsers' && data && data.length > 0) {
                                const currentUserId = window.ApiClient?.getCurrentUserId();
                                const selectedUserId = currentUserId || data[0].Id;
                                if (selectedUserId) {
                                    loadUserDataForUser(selectedUserId);
                                }
                            }
                        }).catch(e => {
                            debugData[key] = { error: `Failed to load ${key}: ${e.message}` };
                            updateDebugDisplay();
                        });
                    });
    
                    function loadUserDataForUser(userId) {
                        console.log('loadUserDataForUser called with userId:', userId);
                        if (!userId || userId === 'undefined' || userId === 'null') {
                            console.warn('Invalid userId provided to loadUserDataForUser:', userId);
                            return;
                        }
    
                        ['userSettings', 'userSectionTypes'].forEach(key => debugData[key] = null);
                        updateDebugDisplay();
    
                        const userApiCalls = [
                            { key: 'userSettings', url: 'ModularHomeViews/User/Settings?userId=' + userId },
                            { key: 'userSectionTypes', url: 'ModularHomeViews/User/SectionTypes?userId=' + userId }
                        ];
    
                        console.log('Making API calls for userId:', userId);
                        userApiCalls.forEach((apiCall) => {
                            const fullUrl = window.ApiClient.getUrl(apiCall.url);
                            window.ApiClient.fetch({
                                url: fullUrl,
                                type: 'GET', dataType: 'json',
                                headers: { accept: 'application/json' }
                            }).then(data => {
                                debugData[apiCall.key] = apiCall.key === 'userSectionTypes' ? (data?.Items || data || []) : data;
                                updateDebugDisplay();
                            }).catch(e => {
                                console.error(`Failed to load ${apiCall.key} for user ${userId}:`, e);
                                debugData[apiCall.key] = { error: `Failed to load ${apiCall.key}: ${e.message}`, selectedUserId: userId };
                                updateDebugDisplay();
                            });
                        });
                    }
    
                    function updateDebugDisplay() {
                        const displayMappings = {
                            adminConfigContent: debugData.pluginConfiguration,
                            adminSectionTypesContent: debugData.sectionTypes,
                            userSettingsContent: debugData.userSettings,
                            userSectionTypesContent: debugData.userSectionTypes
                        };
    
                        Object.entries(displayMappings).forEach(([id, data]) => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.innerHTML = data ? JSON.stringify(data, null, 2) : '<div style="color: #9cdcfe;">Loading...</div>';
                            }
                        });
    
                        const userSelector = document.getElementById('userSelectorControls');
                        if (userSelector && debugData.availableUsers && Array.isArray(debugData.availableUsers)) {
                            const currentUserId = window.ApiClient?.getCurrentUserId();
                            console.log('Current user ID from ApiClient:', currentUserId);
                            console.log('Available users:', debugData.availableUsers);
    
                            // Check if there's already a user selected in the dropdown, preserve that selection
                            const existingDropdown = document.getElementById('debug-user-select');
                            let selectedUserId = existingDropdown ? existingDropdown.value : currentUserId;
    
                            // Fallback to current user or first available user if no valid selection
                            if (!selectedUserId && debugData.availableUsers.length > 0) {
                                selectedUserId = currentUserId || debugData.availableUsers[0].Id;
                                console.log('Using fallback user:', selectedUserId);
                            }
    
                            const options = debugData.availableUsers.map(user => {
                                const isSelected = user.Id === selectedUserId ? ' selected' : '';
                                const youLabel = user.Id === currentUserId ? ' (You)' : '';
                                return '<option value="' + user.Id + '"' + isSelected + '>' + user.Name + youLabel + '</option>';
                            }).join('');
    
                            userSelector.innerHTML = '<div style="display: flex; align-items: center; gap: 1em; flex-wrap: wrap;">' +
                                '<label for="debug-user-select" style="color: #d4d4d4;">Select User:</label>' +
                                '<select id="debug-user-select" style="padding: 0.5em; background: #1e1e1e; color: #fff; border: 1px solid #555; border-radius: 4px;" onchange="onUserSelectionChange()">' +
                                options +
                                '</select>' +
                                '</div>';
                        }
    
                        window.onUserSelectionChange = function() {
                            const selectedUserId = document.getElementById('debug-user-select')?.value;
                            console.log('User selection changed to:', selectedUserId);
                            if (selectedUserId && selectedUserId !== 'undefined' && selectedUserId !== 'null') {
                                ['userSettings', 'userSectionTypes'].forEach(key => debugData[key] = null);
                                updateDebugDisplay();
                                loadUserDataForUser(selectedUserId);
                            } else {
                                console.warn('Invalid user selection:', selectedUserId);
                            }
                        };
                    }
                }
            };
            
            document.querySelector('#homeScreenSectionsConfigurationPage').addEventListener("pageshow", function () {
                HomeScreenSections.init();
                
                HomeScreenSections.initEvents();
                HomeScreenSections.initCacheBust();
            });
        })();
    </script>
</div>
</body>
</html>